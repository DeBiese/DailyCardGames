"use strict";angular.module("Home",[]),angular.module("Games",[]);var app=angular.module("dailycardApp",["ui.router","Home","Games"]);app.config(function(a,b){b.otherwise("/home");var c="";a.state("home",{url:"/home",templateUrl:c+"/Home/homeView.html",controller:"homeController"}).state("wiezer",{url:"/wiezer",templateUrl:c+"/Games/Wiezer/wiezerHomeView.html",controller:"wiezerHomeController"}).state("wiezergame",{url:"/wiezer/game",templateUrl:c+"/Games/Wiezer/wiezerGameView.html",controller:"wiezerGameController"}).state("wiezerrules",{url:"/wiezer/rules",templateUrl:c+"/Games/Wiezer/wiezerRulesView.html"}).state("kinger",{url:"/kinger",templateUrl:c+"/Games/Kinger/kingerHomeView.html",controller:"kingerHomeController"}).state("kingergame",{url:"/kinger/game",templateUrl:c+"/Games/Kinger/kingerGameView.html",controller:"kingerGameController"}).state("kingerrules",{url:"/kinger/rules",templateUrl:c+"/Games/Kinger/kingerRulesView.html"})}),app.run(["$rootScope","$location","$http","$state","indexedDBDataSvc",function(a,b,c,d,e){a.$on("$stateChangeSuccess",function(a,b,c,e){d.previous=e})}]),angular.module("Home").factory("indexedDBDataSvc",function(a,b){var c=a.indexedDB,d=null,e=0,f=0,g=function(){var a=b.defer(),e=1,f=c.open("dailygamesData",e);return f.onupgradeneeded=function(a){d=a.target.result,a.target.transaction.onerror=c.onerror,d.objectStoreNames.contains("players")&&d.deleteObjectStore("players");d.createObjectStore("players",{keyPath:"id"});d.objectStoreNames.contains("games")&&d.deleteObjectStore("games");d.createObjectStore("games",{keyPath:"id"})},f.onsuccess=function(b){d=b.target.result,a.resolve()},f.onerror=function(){a.reject()},a.promise},h=function(){var a=b.defer();if(null===d)a.reject("IndexDB is not opened yet!");else{var c=d.transaction(["players"],"readwrite"),f=c.objectStore("players"),g=[],h=IDBKeyRange.lowerBound(0),i=f.openCursor(h);i.onsuccess=function(b){var c=b.target.result;null===c||void 0===c?a.resolve(g):(g.push(c.value),c.value.id>e&&(e=c.value.id),c["continue"]())},i.onerror=function(b){console.log(b.value),a.reject("Something went wrong!!!")}}return a.promise},i=function(a){var c=b.defer();if(null===d)c.reject("IndexDB is not opened yet!");else{var e=d.transaction(["players"],"readwrite"),f=e.objectStore("players"),g=f["delete"](a);g.onsuccess=function(a){c.resolve()},g.onerror=function(a){console.log(a.value),c.reject("players item couldn't be deleted")}}return c.promise},j=function(a){var c=b.defer();if(null===d)c.reject("IndexDB is not opened yet!");else{var f=d.transaction(["players"],"readwrite"),g=f.objectStore("players");e++;var h=g.put({id:e,text:a,number:0});h.onsuccess=function(a){c.resolve()},h.onerror=function(a){console.log(a.value),c.reject("player item couldn't be added!")}}return c.promise},k=function(a){var c=b.defer();if(null===d)c.reject("IndexDB is not opened yet!");else{var e=d.transaction(["games"],"readwrite"),g=e.objectStore("games"),h=IDBKeyRange.lowerBound(0),i=g.openCursor(h);i.onsuccess=function(b){var d=b.target.result;null===d||void 0===d?c.resolve(null):(1==d.value.active&&d.value.gameType==a&&c.resolve(d.value),d.value.id>f&&(f=d.value.id),d["continue"]())},i.onerror=function(a){console.log(a.value),c.reject("Something went wrong!!!")}}return c.promise},l=function(a,c,e){var g=b.defer();if(null===d)g.reject("IndexDB is not opened yet!");else{var h=d.transaction(["games"],"readwrite"),i=h.objectStore("games");f++;var j=i.put({id:f,active:1,players:a,gameType:c,subType:e,scores:[]});j.onsuccess=function(a){g.resolve()},j.onerror=function(a){console.log(a.value),g.reject("Game item couldn't be added!")}}return g.promise},m=function(a){var c=b.defer();if(null===d)c.reject("IndexDB is not opened yet!");else{var e=d.transaction(["games"],"readwrite"),g=e.objectStore("games");f++;var h=g.put(a);h.onsuccess=function(a){c.resolve()},h.onerror=function(a){console.log(a.value),c.reject("Game item couldn't be updated!")}}return c.promise};return{open:g,getPlayers:h,addPlayer:j,deletePlayer:i,getActiveGame:k,addGame:l,updateGame:m}}),angular.module("Home").constant("keyCodes",{esc:27,enter:13}).directive("playerButton",function(){return{scope:{player:"=playerButton",onClick:"&"},template:'<button class="btn btn-default input-block-level form-control" ng-click="onClick({player : player})" ng-class="{true : \'btn btn-primary input-block-level form-control\', false : \'btn btn-default input-block-level form-control\' }[player.number > 0]"><div ng-if="player.number != 0" class="label label-info">{{player.number}}</div>&nbsp;{{player.text}}</button>'}}).directive("maxRowValue",[function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){a.$watch(function(){return d.$modelValue},function(d){for(var e=0,f=!0,g=0;4>g;g++){if(isNaN(parseInt(a.$root.game.scores[c.rowNumber][g]))){console.log("Nan value inserted"),f=!1;break}e+=parseInt(a.$root.game.scores[c.rowNumber][g])}1==f&&e<c.rowValue?(b.css("border-left","10px white"),b.css("border-right","10px white")):1==f&&e==c.rowValue?(b.css("border-left","10px outset green"),b.css("border-right","10px outset green")):(b.css("border-left","10px outset red"),b.css("border-right","10px outset red"))})}}}]).directive("valueColor",[function(){return{restrict:"A",require:"ngModel",link:function(a,b,c){a.$watch(c.ngModel,function(a){console.log(a);var c=parseInt(a);c>0?b.css("color","green"):0>c?b.css("color","red"):0==c?b.css("color","black"):console.log("Nan value: ",c)})}}}]).directive("selectOnClick",["$window",function(a){return{restrict:"A",link:function(b,c,d){c.on("click",function(){a.getSelection().toString()||this.setSelectionRange(0,this.value.length)})}}}]).directive("keyBind",["keyCodes",function(a){function b(b){var c={};for(var d in b){var e=b[d];a.hasOwnProperty(d)&&(c[a[d]]=e)}return c}return function(a,c,d){var e=b(a.$eval(d.keyBind));c.bind("keypress",function(b){e.hasOwnProperty(b.which)&&a.$apply(function(){console.log(b),a.$eval(e[b.which])})})}}]),angular.module("Games").controller("kingerGameController",["$scope","$rootScope","$state","$window","indexedDBDataSvc",function(a,b,c,d,e){function f(a,c){a.total=a.totalBottom-a.totalTop,b.game.players[c]=a,e.updateGame(b.game).then(function(a){},function(a){console.log(a)})}function g(){"underline"==a.player1.turn?(a.player1.turn="none",a.player2.turn="underline",a.player3.turn="none",a.player4.turn="none"):"underline"==a.player2.turn?(a.player1.turn="none",a.player2.turn="none",a.player3.turn="underline",a.player4.turn="none"):"underline"==a.player3.turn?(a.player1.turn="none",a.player2.turn="none",a.player3.turn="none",a.player4.turn="underline"):(a.player1.turn="underline",a.player2.turn="none",a.player3.turn="none",a.player4.turn="none")}a.canInsertScore=!0,a.topScoreCount=0,a.bottomScoreCount=0,a.rules=function(){c.go("kingerrules")},null==b.game&&c.go("kinger"),a.player1=b.game.players[0],a.player2=b.game.players[1],a.player3=b.game.players[2],a.player4=b.game.players[3],a.stopGame=function(){b.game.active=0,e.updateGame(b.game).then(function(a){b.game=null,e.getPlayers().then(function(a){null!=a&&a.length>3?c.go("kinger"):c.go("home")},function(a){console.log("Error get players",a)})},function(a){console.log("Error update game",a)})},a.leaveTop=function(c){var d;switch(c){case 0:d=a.player1;break;case 1:d=a.player2;break;case 2:d=a.player3;break;case 3:d=a.player4}d.totalTop=0;for(var e=0;12>e;e++)isNaN(parseInt(b.game.scores[e][c]))||(d.totalTop+=parseInt(b.game.scores[e][c]));f(d,c),a.topScoreCount=a.topScoreCount+1},a.leaveBottom=function(c){var d;switch(c){case 0:d=a.player1;break;case 1:d=a.player2;break;case 2:d=a.player3;break;case 3:d=a.player4}d.totalBottom=0;for(var e=12;20>e;e++)isNaN(parseInt(b.game.scores[e][c]))||(d.totalBottom+=parseInt(b.game.scores[e][c]));f(d,c),a.bottomScoreCount=a.bottomScoreCount+1},a.changeTurn=function(){g(),b.game.players[0]=a.player1,b.game.players[1]=a.player2,b.game.players[2]=a.player3,b.game.players[3]=a.player4,e.updateGame(b.game).then(function(){},function(a){console.log(a)})}}]),angular.module("Games").controller("kingerHomeController",["$scope","$rootScope","$state","$window","indexedDBDataSvc",function(a,b,c,d,e){function f(){e.open().then(function(){a.refreshList(),console.log("init")})}function g(){e.getActiveGame("kingen").then(function(d){null!=d&&(b.game=d,a.selectedPlayers=b.game.players,null!=b.game&&c.go("kingergame"))},function(a){console.log(a)})}function h(){i(b.game.players[0]),i(b.game.players[1]),i(b.game.players[2]),i(b.game.players[3]),b.game.scores=[];for(var a=0;20>a;a++)b.game.scores.push([0,0,0,0]);b.game.players[0].turn="underline",b.game.players[1].turn="none",b.game.players[2].turn="none",b.game.players[3].turn="none",e.updateGame(b.game).then(function(a){c.go("kingergame")},function(a){console.log(a)})}function i(a){a.total=0,a.totalTop=0,a.totalBottom=0}a.fourPlayersSelected=!1,a.players=[],a.selectedPlayers=[],a.kingerFull=!1,g(),a.refreshList=function(){e.getPlayers().then(function(b){a.players=b},function(a){console.log(a)})},a.selectPlayer=function(b){if(null!=a.selectedPlayers){var c,d=0,e=!1;for(c in a.selectedPlayers)a.selectedPlayers[c].id==b.id&&(a.selectedPlayers.splice(d,1),b.number=0,e=!0),d++}0==e&&(b.number=d+1,a.selectedPlayers.push(b)),console.log("number "+b.number),4==a.selectedPlayers.length?a.fourPlayersSelected=!0:a.fourPlayersSelected=!1},a.setGameType=function(b){a.kingerFull=b},a.startGame=function(){e.addGame(a.selectedPlayers,"kingen",a.kingerFull).then(function(){e.getActiveGame("kingen").then(function(a){null!=a&&(b.game=a,h())},function(a){console.log(a)})},function(a){console.log(a)})},f()}]),angular.module("Games").controller("wiezerGameController",["$scope","$rootScope","$state","$window","indexedDBDataSvc",function(a,b,c,d,e){function f(){(a.newScore1>0||a.newScore2>0||a.newScore3>0||a.newScore4>0)&&g();var c=[a.newScore1,a.newScore2,a.newScore3,a.newScore4];a.scores.push(c),b.game.players[0]=a.player1,b.game.players[1]=a.player2,b.game.players[2]=a.player3,b.game.players[3]=a.player4,b.game.scores=a.scores,e.updateGame(b.game).then(function(){h(),a.newScore1=0,a.newScore2=0,a.newScore3=0,a.newScore4=0},function(a){console.log(a)})}function g(){"underline"==a.player1.turn?(a.player1.turn="none",a.player2.turn="underline",a.player3.turn="none",a.player4.turn="none"):"underline"==a.player2.turn?(a.player1.turn="none",a.player2.turn="none",a.player3.turn="underline",a.player4.turn="none"):"underline"==a.player3.turn?(a.player1.turn="none",a.player2.turn="none",a.player3.turn="none",a.player4.turn="underline"):(a.player1.turn="underline",a.player2.turn="none",a.player3.turn="none",a.player4.turn="none")}function h(){a.player1.total=0,a.player2.total=0,a.player3.total=0,a.player4.total=0;var b=1;a.scores.forEach(function(c){console.log(c),null==c.counter||0==c.counter?(c.counter=b,b++):b<=c.counter&&(b=c.counter+1),a.player1.total+=parseInt(c[0]),a.player2.total+=parseInt(c[1]),a.player3.total+=parseInt(c[2]),a.player4.total+=parseInt(c[3])}),null!=a.scores&&(a.scores=a.scores.sort(i))}function i(a,b){var c=a.counter,d=b.counter;return c>d?-1:d>c?1:0}a.canInsertScore=!0,a.newScore1=0,a.newScore2=0,a.newScore3=0,a.newScore4=0,a.player1=b.game.players[0],a.player2=b.game.players[1],a.player3=b.game.players[2],a.player4=b.game.players[3],a.scores=b.game.scores,a.checkCanInsertScore=function(){var b=parseInt(a.newScore1,10)+parseInt(a.newScore2,10)+parseInt(a.newScore3,10)+parseInt(a.newScore4,10);0==b?a.canInsertScore=!0:(a.canInsertScore=!1,a.newScore4=0-parseInt(a.newScore1)-parseInt(a.newScore2)-parseInt(a.newScore3),a.canInsertScore=!0)},a.changeTurn=function(){g(),b.game.players[0]=a.player1,b.game.players[1]=a.player2,b.game.players[2]=a.player3,b.game.players[3]=a.player4,e.updateGame(b.game).then(function(){},function(a){console.log(a)})},a.pass=function(){a.newScore1=0,a.newScore2=0,a.newScore3=0,a.newScore4=0,f()},a.insertScore=function(){f()},a.rules=function(){c.go("wiezerrules")},a.stopGame=function(){b.game.active=0,e.updateGame(b.game).then(function(a){b.game=null,e.getPlayers().then(function(a){null!=a&&a.length>3?c.go("wiezer"):c.go("home")},function(a){console.log("Error get players ",a)})},function(a){console.log("Error update game ",a)})},h()}]),angular.module("Games").controller("wiezerHomeController",["$scope","$rootScope","$state","$window","indexedDBDataSvc",function(a,b,c,d,e){function f(){e.open().then(function(){a.refreshList()})}function g(){e.getActiveGame("wiezen").then(function(a){null!=a&&(b.game=a,null==b.game.scores&&(console.log("init scores"),b.game.scores=[]),c.go("wiezergame"))},function(a){console.log(a)})}a.fourPlayersSelected=!1,a.players=[],a.selectedPlayers=[],g(),a.refreshList=function(){e.getPlayers().then(function(b){a.players=b},function(a){console.log(a)})},a.selectPlayer=function(b){if(null!=a.selectedPlayers){var c,d=0,e=!1;for(c in a.selectedPlayers)a.selectedPlayers[c].id==b.id&&(a.selectedPlayers.splice(d,1),b.number=0,e=!0),d++}0==e&&(b.number=d+1,a.selectedPlayers.push(b)),4==a.selectedPlayers.length?a.fourPlayersSelected=!0:a.fourPlayersSelected=!1},a.startGame=function(){console.log("Start wiezer"),a.selectedPlayers[0].turn="underline",a.selectedPlayers[1].turn="none",a.selectedPlayers[2].turn="none",a.selectedPlayers[3].turn="none",e.addGame(a.selectedPlayers,"wiezen",!1).then(function(){g()},function(a){console.log(a)})},f()}]),angular.module("Home").controller("homeController",["$scope","$rootScope","$state","$stateParams","$window","indexedDBDataSvc",function(a,b,c,d,e,f){function g(){f.open().then(function(){a.refreshList(),console.log("init")})}b.canPlay=!1,a.players=[],a.refreshList=function(){f.getPlayers().then(function(c){a.players=c,null!=c&&a.players.length>3?(b.canPlayKingen=!0,b.canPlayWiezen=!0):(b.canPlayKingen=!1,b.canPlayWiezen=!1,f.getActiveGame("kingen").then(function(a){null!=a&&(b.canPlayKingen=!0)},function(a){console.log(a)}),f.getActiveGame("wiezen").then(function(a){null!=a&&(b.canPlayWiezen=!0)},function(a){console.log(a)}))},function(a){console.log(a)})},a.addPlayer=function(){f.addPlayer(a.playerText).then(function(){a.refreshList(),a.playerText=""},function(a){console.log(a)})},a.deletePlayer=function(b){f.deletePlayer(b).then(function(){a.refreshList()},function(a){console.log(a)})},g()}]);